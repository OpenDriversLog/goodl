<link rel="import" href="../../elements/odl/odl-theme.html">
<link rel="import" href="../../components/paper-input/paper-input.html">
<link rel="import" href="../../components/paper-button/paper-button.html">
<link rel="import" href="../../components/i18-n/i18-n.html">
<script src="../../components/travist/jsencrypt/bin/jsencrypt.min.js"></script>
<dom-module id="page-reset-password">
    <template>
        <carbon-route route="{{route}}" pattern="/:mail" data="{{routeParams}}"></carbon-route>

        <i18-n-domain id="domain" on-i18-n-locale-ready="_localeReady" domain="resetpw" locale="{{lang}}"  messages-url="public/translations-autogenerated"></i18-n-domain>
        <i18-n-domain id="domain2" on-i18-n-locale-ready="_localeReady" domain="login" locale="{{lang}}"  messages-url="public/translations-autogenerated"></i18-n-domain>

        <iron-ajax id="ajaxReset"
                   url="../../../resetPassword"
                   content-type="application/x-www-form-urlencoded" body='{ }' ,
                   method="POST"
                   handle-as="text"
                   debounce-duration="300"
                   loading="{{loading}}"
                   on-response="_onResponse">
        </iron-ajax>
        <style include="odl-styles"></style>
        <div class="horizontal layout">
            <paper-material elevation="1" style="width:450px;padding: 1em;" >
                <div>
                    <div>
                        <div>
                            <h2>[[t.resetPasswordTitle]]</h2>
                            <div class="input-field col s12" >
                                <paper-input validator="password-validator" auto-validate="true" type="text" id="reset_email" name="reset_email" value="{{mail}}"  class="validate" label="{{t.mailAddress}}" ></paper-input>

                            </div>

                        </div>
                    </div>
                    <div class="buttons">
                        <paper-button on-tap="submit">[[t.resetPasswordTitle]]</paper-button>

                    </div>
                </div>
            </paper-material>
            <paper-material elevation="1" style="width:500px; padding: 1em;" class="odl-tertiary">
                <div class="odl-tertiary">
                    <div>
                        <h2>[[t.nologinyettitle]]</h2>
                        <p>[[t.nologinyet]]</p>
                    </div>
                    <div>
                        <a on-tap="_register">[[t.register]]</a>
                        <a on-tap="_goBeta">[[t.goBeta]]</a>
                    </div>
                </div>
            </paper-material>

        </div>
    </template>
    <script>
        Polymer({
            is: "page-reset-password",
            properties: {
                mail: {type:String,value:"",computed:"_getSame(routeParams.mail)"}
            },
            _getSame: function(e) {
                return e;
            },
            behaviors:[OdlBehaviors.OdlBehavior],
            ready:function() {
                this.$.ajaxReset.set("url",getReplacedAjaxUri(this.$.ajaxReset.url));

                this.routeExtension="/:resetMail?"
            },
            getHelpText: function(){
                if(this.t && this.t.helpText_login) {
                    return this.t.helpText_login;
                } else {
                    return "Unknown";
                }
            },
            _register:function() {
                setRoute("/register");
            },
            _goBeta:function() {
                document.location.href="https://opendriverslog.de/#beta"
            },
            submit:function(){
                this.$.ajaxReset.body["reset_email"] = this.mail;
                this.$.ajaxReset.generateRequest();
            },
            _onResponse:function(r) {
                if(r.detail.response!=="success") {
                    showError(r.detail.response)
                } else {
                    main.selectedName="login";
                    this.async(function(){showStatus("ResetPwMailComing");},200);

                }
            }


        });

    </script>

</dom-module>