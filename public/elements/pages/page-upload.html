<link rel="import" href="../../elements/odl/odl-theme.html">
<link rel="import" href="../../elements/behaviors/odl-behavior.html">
<link rel="import" href="../../elements/lists/device-list.html">
<link rel="import" href="../../elements/lists/color-list.html">
<link rel="import" href="../../elements/lists/car-list.html">
<link rel="import" href="../../elements/lists/driver-list.html">

<link rel="import" href="../../elements/selectors/device-selector.html">

<link rel="import" href="../../components/i18-n/i18-n.html">
<link rel="import" href="../../components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../components/paper-menu/paper-menu.html">
<link rel="import" href="../../components/paper-input/paper-input.html">
<link rel="import" href="../../components/paper-input/paper-textarea.html">
<link rel="import" href="../../components/paper-card/paper-card.html">

<link rel="import" href="../../components/iron-form/iron-form.html">

<dom-module id="page-upload">
    <template>
        <style include="odl-styles"></style>
        <i18-n-domain id="domain" on-i18-n-locale-ready="_localeReady" domain="upload" locale="{{lang}}" messages-url="public/translations-autogenerated"></i18-n-domain>
        <carbon-route id="uploadRoute" data="{{routeParams}}" route="{{route}}" pattern="/:selectedName"></carbon-route>

        <style include="odl-styles"></style>
        <style>
            paper-card {
                margin:0.25em;
            }
        </style>
        <iron-ajax id="ajaxUploader"
                   url="../../../syncDB"
                   method="POST"
                   debounce-duration="300"
                   loading="{{loading}}"
                   on-response="_uploadDone"
                   on-error="_handleAjaxError"
                   handle-as="text">
        </iron-ajax>

        <div class="vertical layout">
            <paper-card  class="odl-tertiary" style="margin: 1em;padding: 1em;">
                <p> [[t.editUserMessage]]</p>
            </paper-card>
        </div>

        <div class="vertical layout" style="margin: 0.75em; padding: 0.75em;">
            <paper-toolbar class="flex">
                <div class="title">{{title}}</div>
            </paper-toolbar>
            <paper-material class="vertical layout" style="width:100%;">

                <div>
                    <car-list id="cars" style="display:none;" cars="{{cars}}" cars-by-id="{{carsById}}"></car-list>

                    <device-list id="devices" cars="{{cars}}" cars-by-id="{{carsById}}"
                                 drivers="{{drivers}}" drivers-by-id="{{driversById}}"
                                 colors="{{colors}}" colors-by-id="{{colorsById}}" style="display:none;" devices="{{devices}}" devices-by-id="{{devicesById}}"></device-list>
                    <color-list id="colors" style="display:none" colors="{{colors}}" colors-by-id="{{colorsById}}"></color-list>
                    <driver-list id="drivers" style="display:none;" drivers="{{drivers}}" drivers-by-id="{{driversById}}"></driver-list>

                    <div class="vertical layout">
                        <paper-card class="flex" style="min-height:300px;">
                            <neon-animated-pages entry-animation="fade-in-animation" exit-animation="fade-out-animation" class="fit"
                                         id="mapDrawerSlider"
                                         attr-for-selected="name"
                                         selected="{{routeParams.selectedName}}"
                            >
                                <div name="upload">
                                    <form is="iron-form" id="uploadForm">
                                        <paper-input name="upload_files" label="Datei auswählen" type="file" always-float-label>
                                        </paper-input>
                                        <br/>Oder Text einfügen:<br/>
                    <textarea id="upload_externalData" style="width:95%;height:50px;" name="upload_externalData"
                              value="{{externalData}}"></textarea><br/>
                                        <device-selector id="upload_key" selected-device="{{selectedDevice}}"
                                                         on-create-new="newDevice" required devices="{{devices}}"
                                                         devices-by-id="{{devicesById}}"
                                                         label="{{t.upload_key}}"
                                        ></device-selector>
                                        <paper-dropdown-menu id="upload_dataType"
                                                             label="{{t.upload_type}}" always-float-label>
                                            <paper-menu attr-for-selected="name"
                                                        selected="{{selectedType}}" id="innerMenu" class="dropdown-content">
                                                <paper-item name="NMEA/GPRMC" on-tap="_createNew">
                                                    <paper-item-body>
                                                        NMEA/GPRMC
                                                    </paper-item-body>
                                                </paper-item>
                                                <paper-item name="KML" on-tap="_createNew">
                                                    <paper-item-body>
                                                        KML(Google)
                                                    </paper-item-body>
                                                </paper-item>
                                                <paper-item name="CSV" on-tap="_createNew">
                                                    <paper-item-body>
                                                        CSV
                                                    </paper-item-body>
                                                </paper-item>
                                            </paper-menu>
                                        </paper-dropdown-menu>
                                        <paper-button id="submit" on-tap="upload" title="Upload">Upload</paper-button>
                                    </form>
                                </div>
                                <div class="deviceEditPage flex" name="editDevice" id="editDevice">
                                    <device-edit
                                            cars="{{cars}}" cars-by-id="{{carsById}}"
                                            drivers="{{drivers}}" drivers-by-id="{{driversById}}"
                                            colors="{{colors}}" colors-by-id="{{colorsById}}" name="editDevice"
                                            id="deviceEdit" device="{{selectedDevice}}"
                                            on-created="_onDeviceCreated"
                                            on-canceled="_onDeviceEditCanceled"
                                            route="{{tail}}"
                                            on-back="_onDeviceEditCanceled"></device-edit>
                                </div>
                            </neon-animated-pages>
                        </paper-card>
                    </div>
                </div>

            </paper-material>
        </div>
    </template>
    <script>
        Polymer({
            is: "page-upload",
            properties: {
                colors: {
                    type:Array,
                    value:[],
                    notify:true
                },
                colorsById: {
                    type:Object,
                    value:{},
                    notify:true
                },
                cars: {
                    type:Array,
                    value:[],
                    notify:true
                },
                carsById: {
                    type:Object,
                    value:{},
                    notify:true
                }, drivers: {
                    type:Array,
                    value:[],
                    notify:true
                },
                driversById: {
                    type:Object,
                    value:{},
                    notify:true
                },
                devices: {
                    type:Array,
                    value:[],
                    notify:true
                },
                devicesById: {
                    type:Object,
                    value:{},
                    notify:true
                },
                selectedDevice: {
                    type:Object,
                    value:{}
                },
                selectedType: {
                    type:String,
                    value:"NMEA/GPRMC"
                },
                externalData: {
                    type:String,
                    value:""
                }
            },
            behaviors:[OdlBehaviors.OdlBehavior],
            observers:[
                "_rPathChanged(route.path,isActive)"
            ],
            _rPathChanged: function(rPath,isActive) {
                if (isActive)
                    this.async(function(){
                        if(this.route.path=="" && isActive) {
                            this.set("route.path","/upload");
                        }
                    },500)
            },
            ready:function() {
                this.$.ajaxUploader.set("url",getReplacedAjaxUri(this.$.ajaxUploader.url));

                if(this.isActive) this._rPathChanged(this.route.path,this.isActive);
            },
            initFunc: function(wasLoadedBefore) {
                if(wasLoadedBefore) { // refresh relevant lists
                    this.$.devices.fetch();
                    this.$.cars.fetch();
                    this.$.drivers.fetch();
                }
            },
            getHelpText: function(){
                if(this.t && this.t.helpText_upload) {
                    return this.t.helpText_upload;
                } else {
                    return "Unknown";
                }
            },
            _onTranslationUpdate:function(t) {
                if(this.t) {
                    this.navFunctions=[
                        //{key:'Function',title: this.t["Function"], icon: 'dns', href:'javascript:alert("Implement me!"'}
                    ];
                    this.fire("new-nav-functions");
                }
            },
            newDevice: function() {

                this.set("routeParams.selectedName","editDevice");
                this.async(function()
                {
                    this.set("selectedDevice", this.$.deviceEdit.getNew())
                });
            },
            _onDeviceCreated: function(event) {
                this.$.devices.backToList(event);
                if(event.detail.type=="device") {
                    this.set("routeParams.selectedName","upload");
                    this.selectedDevice = event.detail.updatedObject;
                } else {
                    this.set("routeParams.selectedName","editDevice");
                }
            },
            _onDeviceEditCanceled: function(event) {
                this.$.devices.backToList(event);
                if(event.detail.type=="device") {
                    this.set("routeParams.selectedName","upload");
                } else {
                    this.set("routeParams.selectedName","editDevice");
                }
            },
            backToPage: function(event) {
                this.$.devices.backToList(event);
                if(event.detail.type=="device") {
                    this.set("routeParams.selectedName","upload");
                } else {
                    this.set("routeParams.selectedName","editDevice");
                }
            },
            upload:function () {
                load("upload");
                var formData = new FormData(this.$.uploadForm);
                formData.append("upload_key",this.selectedDevice.Description);
                formData.append("upload_dataType",this.selectedType);
                formData.append("upload_externalData",this.externalData);
                this.$.ajaxUploader.body = formData;
                this.$.ajaxUploader.generateRequest();
            },
            _uploadDone: function(r) {
                if(r.detail.response!=="success") {
                    console.error("Error uploading : ", r.detail, r.detail.response);
                    showError(r.detail.response,this.t);
                } else {
                    showToast(this.t.uploadSuccess);

                }
                unload("upload");
            },
            _handleAjaxError: function(e) {
                handleAjaxError(e,this);
            }
        });

    </script>

</dom-module>