<link rel="import" href="../../elements/odl/odl-theme.html">
<link rel="import" href="../../components/paper-input/paper-input.html">
<link rel="import" href="../../components/paper-button/paper-button.html">
<link rel="import" href="../../components/i18-n/i18-n.html">
<script src="../../components/travist/jsencrypt/bin/jsencrypt.min.js"></script>
<dom-module id="page-login">
    <template>
        <carbon-route data="{{routeParams}}" route="{{route}}" pattern="/:user"></carbon-route>

        <i18-n-domain id="domain" on-i18-n-locale-ready="_localeReady" domain="login" locale="{{lang}}"  messages-url="public/translations-autogenerated"></i18-n-domain>
        <iron-ajax id="ajaxLogin"
                   url="../../../handleLogin"
                   content-type="application/x-www-form-urlencoded" body='{ }' ,
                   method="POST"
                   handle-as="json"
                   debounce-duration="300"
                   loading="{{loading}}"
                   on-response="_onLoginResponse">
        </iron-ajax>
        <iron-ajax id="ajaxEnc"
                   url="../../../initEnc"
                   content-type="application/x-www-form-urlencoded" body='{ }' ,
                   method="POST"
                   handle-as="json"
                   debounce-duration="300"
                   loading="{{loading}}"
                   on-response="_onEncResponse">
        </iron-ajax>
        <iron-ajax id="ajaxUsrMan"
                   url="../../../userMan"
                   content-type="application/x-www-form-urlencoded" body='{ }' ,
                   method="POST"
                   handle-as="json"
                   debounce-duration="300"
                   loading="{{loading}}"
                   on-response="_onUsrResponse">
        </iron-ajax>
        <style include="odl-styles"></style>
        <div class="horizontal layout">
            <paper-material elevation="1" style="width:450px;padding: 1em;" >
                <div>
                    <div>
                        <div>
                            <h2>[[t.loginMessage]]</h2>
                            <form  id="loginForm">
                                <paper-input label='[[t.mailAddress]]' on-keydown="checkForEnter" id="login_email" name="login_email" value="{{routeParams.user}}"></paper-input>
                                <paper-input label='[[t.password]]' on-keydown="checkForEnter" type="password" id="login_password" name="login_password" value="{{password]]"></paper-input>

                                <input type="hidden" id="loginregister_nextOp" value="./lhm"/>
                                <br/>
                            </form>
                        </div>
                    </div>
                    <div class="buttons">
                        <a on-tap="initLogin" class="clickable" id="login_submit">[[t.loginTitle]]</a>
                        <a on-tap="resetPassword" class="clickable">[[t.forgotPassword]]</a>
                    </div>
                </div>
            </paper-material>
            <paper-material elevation="1" style="width:500px; padding: 1em;" class="odl-tertiary">
                <div class="odl-tertiary">
                    <div>
                        <h2>[[t.nologinyettitle]]</h2>
                        <p>[[t.nologinyet]]</p>
                    </div>
                    <div>
                        <a class="clickable" on-tap="_register">[[t.register]]</a>
                        <a class="clickable" on-tap="_goBeta">[[t.goBeta]]</a>
                    </div>
                </div>
            </paper-material>

        </div>
    </template>
    <script>
        Polymer({
            is: "page-login",
            properties: {
                user: {type:String,value:"",computed:"_getSame(routeParams.user)"},
                password: {type:String,value:""},
                loading: {type:Boolean, value:false}

            },
            _getSame: function(e) {
                return e;
            },
            checkForEnter: function (e) {
                // check if 'enter' was pressed
                if (e.keyCode === 13) {
                    // enter pressed!
                    this.initLogin();
                }
            },
            behaviors:[OdlBehaviors.OdlBehavior],
            ready:function() {
                this.$.ajaxLogin.set("url",getReplacedAjaxUri(this.$.ajaxLogin.url));
                this.$.ajaxEnc.set("url",getReplacedAjaxUri(this.$.ajaxEnc.url));
                this.$.ajaxUsrMan.set("url",getReplacedAjaxUri(this.$.ajaxUsrMan.url));

                if(!main.user && isApp && window.localStorage.getItem("usr_new_cookie")!==undefined) {
                    this.initLogin();
                }
            },
            getHelpText: function(){
                if(this.t && this.t.helpText_login) {
                    return this.t.helpText_login;
                } else {
                    return "Unknown";
                }
            },
            _register:function() {
                setRoute("register");
            },
            _goBeta:function() {
                document.location.href="https://opendriverslog.de/#beta"
            },
            initLogin:function() {
                load("login");
                this.$.ajaxEnc.body={};
                this.$.ajaxEnc.generateRequest();
            },
            _onLoginResponse:function(r,request) {
                var reqData = r.detail.response;

                if(isApp && window.localStorage.getItem("usr_new_cookie")!==undefined)
                {
                    this.$.ajaxUsrMan.body = {action:"getActive"};
                    this.$.ajaxUsrMan.generateRequest();
                } else {
                    if (reqData.Success == true && reqData.Error == false) {
                        main.set("user", reqData.User);
                        userData = reqData.User;
                        this.async(function () {
                            main._onTranslationUpdate(main.t);
                            setRoute("/lhm/trips/list/-1");
                        });
                        if (isApp) {
                            window.localStorage.setItem("usr_new_cookie", reqData.SessionCookieVal);
                        }
                    } else {
                        showResultErrors(reqData);
                    }
                    unload("login");
                }

            },
            _onUsrResponse: function(r) {
                var reqData = r.detail.response;
                if (reqData.Success) {
                    var u = reqData.Result;
                    main.set("user", u);
                    userData = u;
                    this.async(function () {
                        main._onTranslationUpdate(main.t);
                        setRoute("/lhm/trips/list/-1");
                    });
                }
                unload("login");
            },
            _onEncResponse:function(r) {
                var reqData = r.detail.response;
                if (reqData && reqData.Nonce) { // initial request to get encryption key
                    // Encrypt with the public key...
                    var encrypt = new JSEncrypt();
                    encrypt.setPublicKey(reqData.Nonce);
                    if(isApp && this.password=="" && (this.user=="" ||this.user==undefined) && window.localStorage.getItem("usr_new_cookie")!==undefined) {
                        var encrypted1 = encrypt.encrypt(window.localStorage.getItem("usr_new_cookie").substring(0,80));
                        var encrypted2 = encrypt.encrypt(window.localStorage.getItem("usr_new_cookie").substring(80));
                        this.$.ajaxLogin.body = {
                            cookie :  encrypted1 +"_____"+encrypted2,
                            reqId: reqData.ReqId
                        };
                    } else {
                        var encrypted = encrypt.encrypt(this.password);
                        this.$.ajaxLogin.body =  {
                            password: encrypted,
                            reqId: reqData.ReqId,
                            email:this.user
                        };
                    }
                    if(isApp) {
                        this.$.ajaxLogin.body.FromApp=true;
                    }
                    this.$.ajaxLogin.generateRequest();

                } else {
                    console.Error("Encryption initialisation failed.");
                    unload("login");
                    showError("Internal server error");
                }
            },
            resetPassword:function() {
                setRoute("/resetPassword");
            }

        });

    </script>

</dom-module>