<link rel="import" href="../../elements/odl/odl-theme.html">
<link rel="import" href="../../components/paper-input/paper-input.html">
<link rel="import" href="../../components/paper-button/paper-button.html">
<link rel="import" href="../../components/i18-n/i18-n.html">
<link rel="import" href="../../elements/controls/password-security-bar.html">

<script src="../../components/travist/jsencrypt/bin/jsencrypt.min.js"></script>
<dom-module id="page-new-password">
    <template>
        <carbon-route route="{{route}}" pattern="/:mail/:key" data="{{routeParams}}"></carbon-route>

        <i18-n-domain id="domain" on-i18-n-locale-ready="_localeReady" domain="resetpw" locale="{{lang}}"  messages-url="public/translations-autogenerated"></i18-n-domain>
        <i18-n-domain id="domain2" on-i18-n-locale-ready="_localeReady" domain="register" locale="{{lang}}"  messages-url="public/translations-autogenerated"></i18-n-domain>
        <i18-n-domain id="domain3" on-i18-n-locale-ready="_localeReady" domain="login" locale="{{lang}}"  messages-url="public/translations-autogenerated"></i18-n-domain>

        <iron-ajax id="ajaxReset"
                   url="../../../resetPassword"
                   content-type="application/x-www-form-urlencoded" body='{ }' ,
                   method="POST"
                   handle-as="text"
                   debounce-duration="300"
                   loading="{{loading}}"
                   on-response="_onResetResponse">
        </iron-ajax>
        <iron-ajax id="ajaxEnc"
                   url="../../../initEnc"
                   content-type="application/x-www-form-urlencoded" body='{ }' ,
                   method="POST"
                   handle-as="json"
                   debounce-duration="300"
                   loading="{{loading}}"
                   on-response="_onEncResponse">
        </iron-ajax>
        <style include="odl-styles"></style>
        <div class="horizontal layout">
            <div>
                <div>
                    <div>
                        <h2>[[t.resetPasswordTitle]]</h2>
                        <div class="input-field col s12" >
                            <password-security-bar repeat-valid="{{repeatValid}}" required="true" pw-title="[[t.password]]" repeat-title="[[t.repeatPassword]]" title="[[t.passwordsecurity]]" password="{{password}}" valid="{{valid}}"></password-security-bar>

                        </div>
                        <paper-button on-tap="submit">[[t.resetPasswordTitle]]</paper-button>

                    </div>
                </div>
            </div>

        </div>
    </template>
    <script>
        Polymer({
            is: "page-new-password",
            properties: {
                mail: {type:String,value:"",computed:'_getSame(routeParams.mail)'},
                key:{type:String,value:"",computed:'_getSame(routeParams.key)'},
                password:{type:String,value:""},
                valid:{type:Boolean,value:false}
            },
            behaviors:[OdlBehaviors.OdlBehavior],
            ready: function() {
                this.$.ajaxEnc.set("url",getReplacedAjaxUri(this.$.ajaxEnc.url));
                this.$.ajaxReset.set("url",getReplacedAjaxUri(this.$.ajaxReset.url));

            },
            _getSame: function(e) {
                return e;
            },
            getHelpText: function(){
                if(this.t && this.t.helpText_login) {
                    return this.t.helpText_login;
                } else {
                    return "Unknown";
                }
            },
            _register:function() {
                setRoute("/register");
            },
            _goBeta:function() {
                document.location.href="https://opendriverslog.de/#beta"
            },
            submit:function() {
                if(!this.valid) {
                    if(!this.repeatValid) {
                        showError(this.t.error_passwordsNotMatch);
                    } else {
                        showError(this.t.error_insecurePassword);
                    }
                    return;
                }
                this.$.ajaxEnc.body={};
                this.$.ajaxEnc.generateRequest();
            },
            _onResetResponse:function(r) {
                var res = r.detail.response;

                if(res=="success") {
                    setRoute("/login/"+this.mail);
                    showToast("resetPasswordDone",this.t);
                } else {
                    debugger;
                    showError(res,this.t)
                }

            },
            _onEncResponse:function(r) {
                var reqData = r.detail.response;
                if (reqData && reqData.Nonce) { // initial request to get encryption key
                    // Encrypt with the public key...
                    var encrypt = new JSEncrypt();
                    encrypt.setPublicKey(reqData.Nonce);
                    var encrypted = encrypt.encrypt(this.password);
                    this.$.ajaxReset.body =  {
                        reset_password: encrypted,
                        reqId: reqData.ReqId,
                        reset_email:this.mail,
                        resetKey:this.key
                    };
                    this.$.ajaxReset.generateRequest();

                } else {
                    console.Error("Encryption initialisation failed.")
                }
            },
            resetPassword:function() {
                setRoute("/resetPassword");
            }

        });

    </script>

</dom-module>