<link rel="import" href="../../components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../components/paper-item/paper-icon-item.html">

<link rel="import" href="../../components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../map/overview-map.html">
<link rel="import" href="../odl/odl-theme.html">
<link rel="import" href="../dialogs/help-dialog.html">
<link rel="import" href="../lists/contact-list.html">
<link rel="import" href="../lists/trip-list.html">
<link rel="import" href="../lists/sync-list.html">

<link rel="import" href="../controls/device-time-dropdown.html">
<link rel="import" href="../lists/car-list.html">
<link rel="import" href="../selectors/car-selector.html">

<link rel="import" href="../lists/driver-list.html">
<link rel="import" href="../lists/color-list.html">
<link rel="import" href="../helpers/trips-export.html">
<link rel="import" href="../../components/i18-n/i18-n.html">
<link rel="import" href="../../components/carbon-route/carbon-route.html">

<script src="../../js/jquery-dateformat.js" type="text/javascript"></script>

<dom-module id="page-lhm">

    <template>
        <carbon-route id="lhmRoute" active="{{rActive}}" route="{{route}}" data="{{routeParams}}" pattern="/:lhmSelectedName" tail="{{tail}}"></carbon-route>

        <i18-n-domain id="domain" on-i18-n-locale-ready="_localeReady" domain="lhm" locale="{{lang}}" messages-url="public/translations-autogenerated"></i18-n-domain>

        <style include="odl-styles"></style>
        <style>
            .mobile .lhmNav {
                display:none;
            }
        </style>

        <color-list loading="{{colorsLoading}}"
                    colors="{{colors}}" colors-by-id="{{colorsById}}"></color-list>

        <div class$="vertical layout fit [[ifTrue(isMobile,'mobile','desktop')]]">

            <div class="vertical layout flex">
                <paper-drawer-panel disable-swipe disable-edge-swipe class="flex" id="mapDrawerPanel" style="position:relative;"  drawer-width="[[drawerWidth]]" responsive-width="850px">
                    <div style="overflow:auto;" class="vertical layout flex" main>
                        <template is="dom-if" if="[[!isMobile]]" restamp>
                            <overview-map is-mobile="[[isMobile]]" id="innerOdlMap" class="fill"
                                          trips="{{trips}}"
                                          contacts="{{contacts}}"
                                          contacts-by-id="{{contactsById}}"
                                          style="position:relative;bottom:0px;"
                                          t="{{t}}"
                                          hide-old-contacts="{{hideOldContacts}}"
                                          on-update-contact="updateContact"
                            ></overview-map>
                        </template>
                    </div>

                    <div drawer>
                        <neon-animated-pages entry-animation="fade-in-animation" exit-animation="fade-out-animation" selected-item="{{curPage}}"
                                             selected="{{routeParams.lhmSelectedName}}"
                                             attr-for-selected="name"
                                             class="fit"
                                             entry-animation="slide-from-right-animation"
                                             exit-animation="slide-left-animation" id="mapDrawerSlider">
                            <trip-list  is-mobile="[[isMobile]]" name="trips" id="trips" class$="fit [[ifTrue(isMobile,'mobile','desktop')]]"
                                        is-active="[[_isSameAndAct({{routeParams.lhmSelectedName}},'trips')]]"
                                        route="{{tail}}"
                                        trips="{{trips}}"
                                        loading="{{tripsLoading}}"
                                        include-tracks="[[!isMobile]]"
                                        min-time="{{minTime}}" max-time="{{maxTime}}"
                                        contacts="{{contacts}}"
                                        devices="{{devices}}"
                                        devices-by-id="{{devicesById}}"
                                        include-tracks="true"
                                        contacts="{{contacts}}"
                                        contacts-by-id="{{contactsById}}"
                                        on-contact-created="_contactCreated"
                                        drivers="{{drivers}}"
                                        drivers-by-id="{{driversById}}"
                                        not-reviewed-count="{{notReviewedCount}}"
                                        t="{{t}}"
                                        hide-old-contacts="[[hideOldContacts]]"
                                        cars="[[cars]]"
                                        export-loading="{{exportLoading}}"
                            ></trip-list>
                            <contact-list is-mobile="[[isMobile]]" name="contacts" id="contacts" class$="fit [[ifTrue(isMobile,'mobile','desktop')]]"
                                          is-active="[[_isSameAndAct({{routeParams.lhmSelectedName}},'contacts')]]"
                                          on-toggle-drawer="toggleDrawer"
                                          route="{{tail}}"
                                          trips="{{trips}}"
                                          loading="{{contactsLoading}}"
                                          contacts="{{contacts}}"
                                          contacts-by-id="{{contactsById}}"
                                          on-recalc-trip="recalcTrip"
                                          hide-old-contacts="{{hideOldContacts}}"
                            ></contact-list>
                            <car-list is-mobile="[[isMobile]]" hide-old-contacts="[[hideOldContacts]]" name="cars" id="cars" class$="fit [[ifTrue(isMobile,'mobile','desktop')]]"
                                      is-active="[[_isSameAndAct({{routeParams.lhmSelectedName}},'cars')]]"
                                      route="{{tail}}"
                                      on-toggle-drawer="toggleDrawer"
                                      drivers-by-id="{{driversById}}"
                                      colors="[[colors]]"
                                      loading="{{carsLoading}}"
                                      drivers="{{drivers}}"
                                      cars="{{cars}}"
                                      contacts="{{contacts}}"
                                      cars-by-id="{{carsById}}"></car-list>

                            <driver-list is-mobile="[[isMobile]]" hide-old-contacts="[[hideOldContacts]]" name="drivers" id="drivers"
                                         class$="fit [[ifTrue(isMobile,'mobile','desktop')]]"
                                         is-active="[[_isSameAndAct({{routeParams.lhmSelectedName}},'drivers')]]"
                                         route="{{tail}}"
                                         loading="{{driversLoading}}"
                                         on-toggle-drawer="toggleDrawer"
                                         drivers-by-id="{{driversById}}"
                                         drivers="{{drivers}}"
                                         contacts="{{contacts}}"
                                         contacts-by-id="{{contactsById}}"
                            ></driver-list>
                            <device-list is-mobile="[[isMobile]]" hide-old-contacts="[[hideOldContacts]]"
                                         on-devices-checked-changed="_onDevicesCheckedChanged"
                                         is-active="[[_isSameAndAct({{routeParams.lhmSelectedName}},'devices')]]"
                                         class$="fit [[ifTrue(isMobile,'mobile','desktop')]]"
                                         route="{{tail}}"
                                         name="devices" id="devices" devices="{{devices}}"
                                         on-toggle-drawer="toggleDrawer"
                                         loading="{{devicesLoading}}"
                                         drivers-by-id="{{driversById}}"
                                         drivers="{{drivers}}"
                                         auto-fetch="false" route="{{tail}}"
                                         devices-by-id="{{devicesById}}" colors="{{colors}}"
                                         colors-by-id="{{colorsById}}" cars="{{cars}}"
                                         cars-by-id="{{carsById}}" show-edit="true"></device-list>

                            <sync-list is-mobile="[[isMobile]]" t="{{t}}" on-synced="_onSynced" name="syncs" id="syncs" syncs="{{syncs}}"
                                       class$="fit [[ifTrue(isMobile,'mobile','desktop')]]"
                                       is-active="[[_isSameAndAct({{routeParams.lhmSelectedName}},'syncs')]]"
                                       route="{{tail}}"
                                       loading="{{syncsLoading}}"
                                       on-toggle-drawer="toggleDrawer"
                                       syncs-by-id="{{syncsById}}"
                                       syncs="{{syncs}}"
                                       syncs-by-id="{{syncsById}}" colors="{{colors}}" show-edit="true"></sync-list>

                        </neon-animated-pages>
                    </div>

                </paper-drawer-panel>
            </div>
        </div>

    </template>

    <script>
        function editContact(id) {
            Page_lhm.openContacts(function() {
                Page_lhm.openEdit(id);
            },true);
        }
        function moveContact(id) {
            Page_lhm.moveContact(id);
        }
        function endMoveContact(id) {
            Page_lhm.endMoveContact(id);
        }

        function createContact(address) {
            Page_lhm.openContacts(function() {
                var contact = Page_lhm.$.contacts.$.contactEdit.getNew();
                address = $.extend(true, {}, address);
                address.Id = -1;
                contact.Address = address;
                Page_lhm.openCreate(undefined,contact);
            },true);
        }
        function editTrip(tripId) {
            if(tripId>-1) {
                Page_lhm.openTrips(function() {
                    Page_lhm.$.trips.showDetailsForId(tripId);
                });
            }
        }
        function editTripWithEndKp(kpId) {
            Page_lhm.openTrips(function(){
                var tripId = -1;
                $.each(Page_lhm.trips, function(i,t){
                    if(t.EndKeyPointId==kpId) {
                        tripId = t.Id;
                        return;
                    }
                });
                if(tripId>-1) {
                    Page_lhm.$.trips.showDetailsForId(tripId);
                }
            });
        }

        function editTripWithStartKp(kpId) {
            Page_lhm.openTrips(function(){
                var tripId = -1;
                $.each(Page_lhm.trips, function(i,t){
                    if(t.StartKeyPointId==kpId) {
                        tripId = t.Id;
                        return;
                    }
                });
                if(tripId>-1) {
                    Page_lhm.$.trips.showDetailsForId(tripId);
                }
            });
        }
        $( window ).resize(function() {
            if(Page_lhm) {
                if(Page_lhm.isMobile)
                    Page_lhm.drawerWidth=$(window).width()+"px";
                else
                    Page_lhm.drawerWidth=Math.min(580,$(window).width())+"px";
            }
        });
        var Page_lhm;
        Polymer({
            is: "page-lhm",
            behaviors:[OdlBehaviors.OdlBehavior],
            get map() {
                if(this.$$("#innerOdlMap"))
                    return this.$$("#innerOdlMap").$.innerMap.map;
            },
            get odlmap() {
                return this.$$("#innerOdlMap");
            },
            updateContact:function(event) {
                this.$.contacts.updateContact(event.detail);
            },
            properties: {
                cars: {
                    type: Array,
                    notify: true,
                    value: []
                },
                tripsLoading: {
                    type:Boolean,
                    observer:"_singleLoadingChanged"
                },
                carsLoading: {
                    type:Boolean,
                    observer:"_singleLoadingChanged"
                },
                driversLoading: {
                    type:Boolean,
                    observer:"_singleLoadingChanged"
                },
                contactsLoading: {
                    type:Boolean,
                    observer:"_singleLoadingChanged"
                },
                devicesLoading: {
                    type:Boolean,
                    observer:"_singleLoadingChanged"
                },
                syncsLoading: {
                    type:Boolean,
                    observer:"_singleLoadingChanged"
                },
                selectedCarId: {
                    type:Number,
                    value:-1
                },
                hideOldContacts: {
                    type: Boolean,
                    value:true
                },
                exportLoading: {
                    type:Boolean,
                    observer:"_singleLoadingChanged"
                },
                colorsLoading: {
                    type:Boolean,
                    observer:"_singleLoadingChanged"
                },
                loading: {
                    type:Boolean,
                    notify:true
                },
                carsById: {
                    type: Object,
                    notify: true,
                    value: {}
                },
                colors: {
                    type: Array,
                    notify: true,
                    value: [],
                },
                contacts: {
                    type: Array,
                    notify: true,
                    value: []
                },
                test:{
                    type:Object
                },
                contactsById: {
                    type: Object,
                    notify: true,
                    value: {}
                },
                driversById: {
                    type: Object,
                    notify: true,
                    value: {}
                },
                drawerCollapsed: {
                    type: Boolean,
                    value: undefined
                },
                devices: {
                    type: Array,
                    value: [],
                    observer: '_filtersChanged',
                    notify:true
                },
                syncs: {
                    type: Array,
                    value: [],
                    notify:true
                },
                drivers: {
                    type: Array,
                    notify: true,
                    value: []
                },
                minTime: {
                    type: Date,
                    notify: true,
                    value: new Date(0,0,0),
                    observer: '_filtersChanged'
                },
                maxTime: {
                    type: Date,
                    notify: true,
                    value: new Date(0,0,0),
                    observer: '_filtersChanged'
                },
                devicesById: {
                    type: Object,
                    notify: true,
                    value: {}
                },
                syncsById: {
                    type: Object,
                    notify: true,
                    value: {}
                },
                trips: {
                    type: Array,
                    notify: true,
                    value: []
                },
                colorsById: {
                    type: Object,
                    value: {},
                    notify:true
                },
                prevPage: {
                    type: Object,
                    value: function() {
                        return this.$.trips;
                    }
                },
                curPage: {
                    type: Object,
                    value: function() {
                        return this.$.trips;
                    },
                    observer:"pageSelected"
                },
                navFunctions: {type:Object, notify:true},
                notReviewedCount: {
                    type:Number,
                    observer:"_notReviewedCountChanged"
                },
                drawerWidth: {
                    type:String,
                    value: function() {
                        if(isMobile) return $(window).width()+"px";
                        return Math.min(580,$(window).width())+"px"
                    }
                }
            },
            observers: [
                '_filtersChanged(devices.splices)',
                "_rPathChanged(route.path,isActive)"
            ],
            _rPathChanged: function(rp,isActive) {
                if(isActive)
                    this.async(function(){
                        if(this.route.path=="" && this.isActive) {
                            this.set("route.path","/trips");
                        }
                    },500);
            },
            _isSameAndAct: function(a,b) {
                return this.isActive && a==b;
            },
            _notReviewedCountChanged:function(newVal) {
                this.async(function(){
                    main.set("menuitems.0.items.0.subitems.0.badgeLabel",newVal)
                },100);
            },
            initFunc: function(wasLoadedBefore) {
                this.openMapDrawer();
                if(wasLoadedBefore) { // refresh relevant lists
                    this.$.trips.fetch();
                    this.$.devices.fetch();
                    this.$.syncs.fetch();
                    this.$.cars.fetch();
                    this.$.drivers.fetch();
                    this.$.contacts.fetch();
                }
            },
            _onSynced: function(e) {
                if(e.detail.response) {
                    debugger;
                    if(e.detail.response.updatedContacts) {

                    }
                    if(e.detail.response.updatedTrips) {

                    }
                } else {
                    console.warn("onSynced called without response object?",e);
                }

            },
            moveContact:function(id) {
                this.$$("#innerOdlMap").moveContact(id);
            },
            endMoveContact:function(id) {
                this.$$("#innerOdlMap").endMoveContact(id);
            },
            getHelpText: function(){
                if(this.t && this.t.helpText_lhm) {
                    return this.t.helpText_lhm;
                } else {
                    return "Unknown";
                }
            },
            recalcTrip:function(event) {
                this.$.trips.recalcTrip(event.detail.key,event.detail.trip);
            },
            _singleLoadingChanged : function() {
                this.loading = this.colorsLoading || this.exportLoading || this.tripsLoading || this.carsLoading || this.driversLoading || this.contactsLoading || this.devicesLoading|| this.syncsLoading;
            },
            _contactCreated: function(event) {
                console.log('trip-list: contact was created', event);
                this.$.contacts._contactCreated(event);
            },
            /**
             * Switches page, opening list on the given page and calling finishFunc when finished.
             * @param {string} page - The page to be selected (e.g. "trips"
             * @param {function} [finishFunc] The function to be called when finished
             * @param {boolean} [dontOpenList] Do not open list page on the selected page
             */
            switchPage: function(page, finishFunc, dontOpenList) {
                var p = this.$$('#' + page);

                this.openMapDrawer();
                // return to list on the current page, to make sure
                // we have no pending changes
                if(this.prevPage && this.prevPage.openList && !dontOpenList) {
                    var that = this;
                    this.prevPage.openList(false,-1,function() {
                        that.prevPage = that.$$('#' + page);
                        that.set("routeParams.lhmSelectedName",page);

                        if (typeof(finishFunc) === 'function') {
                            finishFunc();
                        }
                    });
                } else {
                    this.prevPage = p;
                    this.set("routeParams.lhmSelectedName",page);
                    if (typeof(finishFunc) === 'function') {
                        finishFunc();
                    }
                }
                this.curPage = p;
            },
            /**
             * Event when page changed - rendering lists on the page
             * @param pg - the page that was opened
             */
            pageSelected: function(pg) {
                if(!pg) {
                    return;
                }
                this.curPage = pg;
                this.async(function(){
                    pg.renderLists();
                });
                // document.querySelector('iron-list')._render();
            },
            /**
             * Ready-event
             */
            ready: function() {
                Page_lhm = this;
                this.prevPage = this.curPage;
                if(this.prevPage===undefined) this.prevPage=this.$.trips;
                if(this.isActive) {
                    this._rPathChanged(this.route.path,this.isActive);
                }
            },
            /**
             * Opens/hides the drawer left to the map
             */
            toggleMapDrawer: function () {
                if(this.drawerCollapsed === undefined) {
                    // on small screens, drawer is collapsed by default
                    this.drawerCollapsed = this.$.mapDrawerPanel.narrow;
                }
                if (this.drawerCollapsed) {
                    this.openMapDrawer();
                } else {
                    this.hideMapDrawer();
                }
            },
            /**
             * Opens the drawer left to the map
             */
            openMapDrawer: function() {
                var d = this.$.mapDrawerPanel;
                d.drawerWidth = this.drawerWidth;
                this.drawerCollapsed = false;
                if (d.narrow) {
                    d.openDrawer();
                }
                var m = this.map;
                if(m)
                    window.setTimeout(function () {
                        m.invalidateSize();
                    }, 500);
            },
            /**
             * Closes the drawer left to the map
             */
            hideMapDrawer: function() {
                var d = this.$.mapDrawerPanel;
                if (d.narrow) {
                    d.closeDrawer();
                } else {
                    d.drawerWidth = "0px;";
                }
                this.drawerCollapsed = true;
                var m = this.map;
                if(m)
                    window.setTimeout(function () {
                        m.invalidateSize();
                    }, 500);
            },
            /**
             * Reloads trips when the filters changed (min/max timestamps or devices)
             * @private
             */
            _filtersChanged: function () {
                if (this.filtersChanging) {
                    return;
                }
                this.filtersChanging = true;
                var that = this;
                // debounce
                window.setTimeout(function () {
                    console.log('Filters on map changed');
                    var zeroDate = new Date(0,0,0).getTime();
                    if (that.minTime.getTime() == zeroDate || that.maxTime.getTime() == zeroDate || that.devices.length == 0) {
                        console.log('Filters for map not completely set - do nothing');
                        that.filtersChanging = false;
                        return;
                    }
                    that.filtersChanging = false;
                }, 100);
            },
            openTrips: function(finishFunc,dontOpenList) {
                this.switchPage("trips",finishFunc,dontOpenList);
            },
            openCars: function(finishFunc,dontOpenList) {
                this.switchPage("cars",finishFunc,dontOpenList);
            },
            openContacts: function(finishFunc,dontOpenList) {
                this.switchPage("contacts",finishFunc,dontOpenList);
            },
            openDrivers: function(finishFunc,dontOpenList) {
                this.switchPage("drivers",finishFunc,dontOpenList);
            },
            openDevices: function(finishFunc,dontOpenList) {
                this.switchPage("devices",finishFunc,dontOpenList);
            },
            openSyncs: function(finishFunc,dontOpenList) {
                this.switchPage("syncs",finishFunc,dontOpenList);
            },
            openEdit: function(id, finishFunc) {
                if(this.curPage.openEdit)
                    this.curPage.openEdit(true,id, finishFunc)
            },
            openCreate: function(finishFunc,dummyItem) {
                if(this.curPage.openCreate)
                    this.curPage.openCreate(true, finishFunc,dummyItem)
            },
            /**
             * Return updated navigation functions if new translations available
             * @param t - the new translation object
             * @private
             */
            _onTranslationUpdate:function(t) {
                if(this.t) {
                    this.navFunctions=[
                        {key:'trips',title: this.t["Trips"], icon: 'dns', href:'javascript:Page_lhm.openTrips();',badgeLabel:this.trips.notReviewedCount},
                        {key:'contacts',title: this.t["Contacts"], icon: 'account-circle', href:'javascript:Page_lhm.openContacts();'},
                        {key:'cars',title: this.t["Cars"], icon: 'maps:directions-car', href:'javascript:Page_lhm.openCars();'},
                        {key:'drivers',title: this.t["Drivers"], icon: 'notification:airline-seat-recline-normal', href:'javascript:Page_lhm.openDrivers();'},
                        {key:'devices',title: this.t["devices"], icon: 'class', href:'javascript:Page_lhm.openDevices();'},
                        {key:'syncs',title: this.t["syncs"], icon: 'autorenew', href:'javascript:Page_lhm.openSyncs();'}

                    ];
                    if(main.user && main.user.Level==1337) {
                        this.navFunctions.push({key:'reprocess',title: "Reprocess", icon: 'gavel', href:'javascript:Page_lhm.reprocessCurrentTimeSpan();'});
                    }
                    this.fire("new-nav-functions");
                }
            },
            /**
             * Fire filters changed when devices changed
             * @private
             */
            _onDevicesCheckedChanged: function() {
                this.$.trips._filtersChanged();
            },
            /**
             * Only allowed for admins - delete&recalculate trips server-side for selected timespan
             */
            reprocessCurrentTimeSpan : function() {
                var data = {};
                data["minTime"] = this.minTime.getTime();
                data["maxTime"] = this.maxTime.getTime();
                data["ajax"] = "reprocess";
                showLoad();
                $.ajax({
                    type: "POST",
                    url: "./jsonapi",
                    data: data,
                    async: true,
                    dataType: 'json',
                    success: function(result) {
                        if (result.Error != false) {
                            showError(result.ErrorMessage);
                            hideLoad();
                            return;
                        }
                        location.reload();
                        hideLoad();
                    },
                    error: function(result) {
                        showError(T("Error") + ": " + result.responseText);
                        hideLoad();
                    }
                });
            }
        });
    </script>

</dom-module>
