<link rel="import" href="../odl/odl-theme.html">
<link rel="import" href="active-tutorial.html">
<link rel="import" href="../behaviors/odl-behavior.html">
<style>
    .active-tutorial-highlighted {
        background-color:red;
    }
</style>
<dom-module id="odl-tutorial">
    <template>
        <i18-n-domain id="domain" on-i18-n-locale-ready="_localeReady" domain="tutorial" locale="{{lang}}" messages-url="public/translations-autogenerated"></i18-n-domain>
        <iron-ajax id="ajaxTutorialMan"
                   url="../../../tutorialMan"
                   content-type="application/x-www-form-urlencoded" body='{ "action": "read" }' ,
                   method="POST"
                   handle-as="json"
                   debounce-duration="300"
                   loading="{{loading}}"
                   on-response="_tutorialManResponse">
        </iron-ajax>

        <active-tutorial disable-text="{{t.disableTutorial}}" id="tutorial" disabled="{{_disabled}}" on-disabled="_tutDisabled" on-enabled="_tutEnabled" last-milestone="{{lastMilestone}}">
            <tutorial-step id="step_openLhm1" highlighted-item="#nav_lhm" pre-condition="{{!_isSame(selectedName,'lhm')}}"
                           post-condition="{{_isSame(selectedName,'lhm')}}">
                {{t.openLhmTut}}
            </tutorial-step>
            <tutorial-step on-opened="_showIntroduction" id="step_openContacts1" highlighted-item="#nav_contacts"
                           pre-condition="{{_isSame('lhm',selectedName)}}"
                           post-condition="{{_isSame('lhm',selectedName,'contacts',lhmSelectedName)}}">
                {{t.openContacts1}}
            </tutorial-step>
            <tutorial-step id="step_createContact1" on-deactivate="_saveContactsEntryCount"
                           highlighted-item="#newContactBtn" pre-condition="{{_isSame('lhm',selectedName,'contacts',lhmSelectedName)}}"
                           post-condition="{{_isSame('contacts',lhmSelectedName,'lhm',selectedName,'edit',lhmListSelectedName)}}">
                {{t.createContact1}}
            </tutorial-step>
            <tutorial-step id="step_createContact2" highlighted-item="#contactEdit #saveButton,#contactEdit #workRadio"
                           pre-condition="{{_isSame('lhm',selectedName,'edit',lhmListSelectedName,'contacts',lhmSelectedName)}}" is-milestone
                           post-condition="{{_hasNewEntries(contacts.length,lastEntryCounts,'contacts')}}">
                {{t.createContact2}}
            </tutorial-step>
            <tutorial-step id="step_openLhm2" highlighted-item="#nav_lhm" pre-condition="{{!_isSame(selectedName,'lhm')}}"
                           post-condition="{{_isSame(selectedName,'lhm')}}">
                {{t.openLhmImport}}
            </tutorial-step>
            <tutorial-step id="step_importContacts1" highlighted-item="#nav_syncs"
                           pre-condition="{{_isSame('lhm',selectedName)}}"
                           post-condition="{{_isSame('lhm',selectedName,'syncs',lhmSelectedName)}}">
                {{t.importContacts1}}
                <paper-button on-tap="_setMilestoneDone" milestonetoset="step_importContacts3">
                    {{t.skip}}
                </paper-button>.
            </tutorial-step>
            <tutorial-step id="step_importContacts2" on-deactivate="_saveSyncsEntryCount"
                           highlighted-item="#newSyncBtn"
                           pre-condition="{{_isSame('lhm',selectedName,'syncs',lhmSelectedName)}}"
                           post-condition="{{_isSame('lhm',selectedName,'edit',lhmListSelectedName)}}">
                {{t.importContacts2}}
            </tutorial-step>
            <tutorial-step id="step_importContacts3" highlighted-item="#syncEdit #saveButton"
                           pre-condition="{{_isSame('lhm',selectedName,'edit',lhmListSelectedName,'syncs',lhmSelectedName)}}"
                           post-condition="{{_hasNewEntries(syncs.length,lastEntryCounts,'syncs')}}"
                           is-milestone>
                {{t.importContacts3}}
            </tutorial-step>
            <tutorial-step id="step_openLhm3" highlighted-item="#nav_lhm" pre-condition="{{!_isSame(selectedName,'lhm')}}"
                           post-condition="{{_isSame(selectedName,'lhm')}}">
                {{t.openLhmDrivers}}
            </tutorial-step>
            <tutorial-step id="step_openDrivers0" highlighted-item="#nav_drivers"
                           pre-condition="{{_hasNewEntries(syncs.length,lastEntryCounts,'syncs')}}"
                           post-condition="{{!_isSame('lhm',selectedName,'syncs',lhmSelectedName)}}">
                {{t.openDrivers0}}
            </tutorial-step>
            <tutorial-step id="step_openDrivers1" highlighted-item="#nav_drivers"
                           pre-condition="{{_isSame('lhm',selectedName)}}"
                           post-condition="{{_isSame('lhm',selectedName,'drivers',lhmSelectedName)}}">
                {{t.openDrivers1}}
            </tutorial-step>
            <tutorial-step id="step_createDriver1" on-deactivate="_saveDriversEntryCount"
                           highlighted-item="#newDriverBtn"
                           pre-condition="{{_isSame('lhm',selectedName,'drivers',lhmSelectedName,'lhm',selectedName)}}"
                           post-condition="{{_isSame('lhm',selectedName,'edit',lhmListSelectedName,'lhm',selectedName,'drivers',lhmSelectedName)}}">
                {{t.createDriver1}}
            </tutorial-step>
            <tutorial-step id="step_createDriver2" highlighted-item="#driverEdit #saveButton"
                           pre-condition="{{_isSame('lhm',selectedName,'edit',lhmListSelectedName,'drivers',lhmSelectedName)}}" is-milestone
                           post-condition="{{_hasNewEntries(drivers.length,lastEntryCounts,'drivers')}}">
                {{t.createDriver2}}
            </tutorial-step>
            <tutorial-step id="step_openLhm4" highlighted-item="#nav_lhm" pre-condition="{{!_isSame(selectedName,'lhm')}}"
                           post-condition="{{_isSame(selectedName,'lhm')}}">
                {{t.openLhmCars}}
            </tutorial-step>
            <tutorial-step id="step_openCars1" highlighted-item="#nav_cars"
                           pre-condition="{{_isSame('lhm',selectedName)}}"
                           post-condition="{{_isSame('lhm',selectedName,'cars',lhmSelectedName)}}">
                {{t.openCars1}} </tutorial-step>
            <tutorial-step id="step_createCar1" on-deactivate="_saveCarsEntryCount"
                           highlighted-item="#newCarBtn" pre-condition="{{_isSame('cars',lhmSelectedName)}}"
                           post-condition="{{_isSame('lhm',selectedName,'cars',lhmSelectedName,'edit',lhmListSelectedName)}}">
                {{t.createCar1}}
            </tutorial-step>
            <tutorial-step id="step_createCar2" highlighted-item="#carEdit #saveButton"
                           pre-condition="{{_isSame('lhm',selectedName,'edit',lhmListSelectedName,'cars',lhmSelectedName)}}"
                           is-milestone post-condition="{{_hasNewEntries(cars.length,lastEntryCounts,'cars')}}">
                {{t.createCar2}}
            </tutorial-step>
            <tutorial-step id="step_openLhm5" highlighted-item="#nav_lhm" pre-condition="{{!_isSame(selectedName,'lhm')}}"
                           post-condition="{{_isSame(selectedName,'lhm')}}">
                {{t.openLhmDevices}}
            </tutorial-step>
            <tutorial-step id="step_openDevices1" highlighted-item="#nav_devices"
                           pre-condition="{{_isSame('lhm',selectedName)}}"
                           post-condition="{{_isSame('lhm',selectedName,'devices',lhmSelectedName)}}"
            >
                {{t.openDevices1}}
            </tutorial-step>

        </active-tutorial>
    </template>

    <script>
        Polymer({
            is: "odl-tutorial",
            behaviors: [OdlBehaviors.OdlBehavior],
            properties: {
                lhmSelectedName: {
                    type:String,
                    notify:true
                },
                lhmListSelectedName: {
                    type:String,
                    notify:true
                },selectedName: {
                    type:String,
                    notify:true
                },
                contacts: {
                    type:Object
                },
                devices: {
                    type:Object
                },
                cars: {
                    type:Object
                },
                drivers: {
                    type:Object
                },
                syncs: {
                    type:Object
                },
                user: {
                    type:Object,
                    value:undefined,
                    notify:true
                },
                lastMilestone : {
                    type:String,
                    value:undefined,
                    observer:"_lastMilestoneChanged"
                },
                disabled: {
                    type:Number,
                    value:2,
                    observer:"_disabledChanged"
                },
                _disabled:{
                    type:Boolean,
                    computed:"_getBoolDisabled(disabled)"
                },
                lastEntryCounts: {
                    type:Object,
                    value:{}
                },
                editId: {
                    type:Number,value:-1
                },
                introWasShown: Boolean,
                nextDisabled: Boolean,
                prevDisabled: Boolean
            },
            _getBoolDisabled: function(disabled) {
                if(disabled===undefined || disabled<=0) return false;
                return true;
            },
            ready : function() {
                this.startReq();
            },
            startReq : function() {
                if(this.user && (this.user.TutorialDisabled<1 || !this.user.TutorialDisabled)) {
                    this.$.ajaxTutorialMan.body = {action: "read"};
                    this.$.ajaxTutorialMan.generateRequest();
                } else {
                    this.async(function(){
                        this.startReq();
                    },1000);
                }
            },
            _setMilestoneDone: function(e) {
                this.lastMilestone = e.target.getAttribute("milestonetoset");
                this.$.tutorial.setActiveStep();
            },
            isLoggedIn: function(user) {
                return user != undefined;
            },
            _isSame: function() {
                if(arguments.length !== 0) {
                    var match = true;
                    for(var i=1;i<arguments.length;i+=2) {
                        if(arguments[i-1]!=arguments[i]) {
                            match = false;
                            break;
                        }
                    }
                    return match;
                }
                else {
                    return false;
                }
            },
            _hasEntries: function(list) {
                return list.length !== undefined && list.length>0
            },
            // precondition : number of previous was saved with _saveEntryCount
            _hasNewEntries: function(listlength,lastEntryCounts,listname) {
                return listlength !== undefined && listlength>this.lastEntryCounts[listname];
            },
            _tutorialManResponse: function(request) {
                if(request.detail.response == null) {
                    console.error("Milestone saving/getting was not successful : ", request, request.detail.statusText);
                }
                else if(request.detail.response.Success == false) {
                    console.error("Milestone saving/getting was not successful : ", request, request.detail.response);
                } else {
                    if(request.detail.response.TutorialInfo) { // read
                        this.lastMilestone = request.detail.response.TutorialInfo.LastMilestone;
                        this.disabled = request.detail.response.TutorialInfo.Disabled;

                    }
                    else { // update
                        // TODO : Re-enable this when tutorial is not toast-based anymore
                        //showToast(this.t.tutorialstep_saved);
                    }
                }
            },
            _lastMilestoneChanged : function(newVal,oldVal) {
                if(newVal!="" && oldVal!==undefined && newVal!="-" && oldVal!="-") {
                    this.$.ajaxTutorialMan.body = {action: "update", tutorial: JSON.stringify({LastMilestone: newVal})};
                    this.$.ajaxTutorialMan.generateRequest();
                }

            },
            _disabledChanged: function(newVal,oldVal) {
                if(oldVal!==undefined && newVal!=0 && oldVal!=2) {
                    this.$.ajaxTutorialMan.body = {action: "update", tutorial: JSON.stringify({Disabled: newVal})};
                    this.$.ajaxTutorialMan.generateRequest();
                }
            },
            _tutDisabled: function(e) {
                this.disabled = 1;
                this.user.TutorialDisabled = 1;
            },
            _tutEnabled: function(e) {
                this.disabled = -1;
                this.user.TutorialDisabled = -1;
            },
            _saveContactsEntryCount: function(){
                this.set("lastEntryCounts.contacts",this.contacts==undefined ? 0 : this.contacts.length);
            },
            _saveDriversEntryCount: function(){
                this.set("lastEntryCounts.drivers",this.drivers==undefined ? 0 : this.drivers.length);
            },
            _saveCarsEntryCount: function(){
                this.set("lastEntryCounts.cars",this.cars==undefined ? 0 : this.cars.length);
            },
            _saveDevicesEntryCount: function(){
                this.set("lastEntryCounts.devices",this.devices==undefined ? 0 : this.devices.length);
            },
            _saveSyncsEntryCount: function(){
                this.set("lastEntryCounts.syncs",this.syncs==undefined ? 0 : this.syncs.length);
            },
            _showIntroduction: function() {
                this.async(function(){
                    if(this.$.tutorial.steps[1].visible && !this.introWasShown) {
                        showStatus(this.t.tutorialIntroduction);
                        this.introWasShown = true;
                    }
                },1000);
            }


        });
    </script>
</dom-module>

